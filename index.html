<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Golf Bet Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem;
    background: #f9f9f9;
  }
  h1 {
    text-align: center;
  }
  .input-group {
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  label {
    min-width: 140px;
    font-weight: bold;
  }
  button {
    padding: 0.3rem 0.7rem;
    cursor: pointer;
  }
  input[type="text"], input[type="number"] {
    width: 50px;
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 0.4rem 0.7rem;
    text-align: center;
  }
  th {
    background: #ddd;
  }
  .money-positive {
    color: green;
    font-weight: bold;
  }
  .money-negative {
    color: red;
    font-weight: bold;
  }
  .controls {
    text-align: center;
    margin-top: 1rem;
  }
  .controls button {
    margin: 0 0.3rem;
    padding: 0.5rem 1rem;
  }
</style>
</head>
<body>
<h1>Golf Bet Calculator</h1>

<div id="setup">
  <div class="input-group">
    <label>Number of Players:</label>
    <button id="players-minus">-</button>
    <input type="number" id="numPlayers" value="4" min="2" max="8" readonly />
    <button id="players-plus">+</button>
  </div>
  <div class="input-group">
    <label>Skin Value ($):</label>
    <button id="skin-minus">-</button>
    <input type="number" id="skinValue" value="5" min="1" max="100" readonly />
    <button id="skin-plus">+</button>
  </div>
  <button id="startGameBtn">Start Game</button>
</div>

<div id="game" style="display:none;">
  <div>
    <p>Hole <span id="currentHole">1</span> / 18</p>
  </div>
  <table>
    <thead>
      <tr>
        <th>Player</th>
        <th>Name</th>
        <th>Handicap</th>
        <th>Strokes</th>
        <th>Bonus</th>
        <th>Penalty</th>
        <th>Money ($)</th>
      </tr>
    </thead>
    <tbody id="playersTableBody"></tbody>
  </table>

  <div class="controls">
    <button id="prevHoleBtn">Previous Hole</button>
    <button id="nextHoleBtn">Next Hole</button>
  </div>

  <div style="margin-top:1rem;">
    <h3>Total Money:</h3>
    <ul id="totalMoneyList"></ul>
  </div>
</div>

<script>
(() => {
  // --- State ---
  let state = {
    numPlayers: 4,
    skin: 5,
    currentHole: 1,
    players: [],  // { name, handicap, strokes, bonus, penalty }
    holeData: [], // Array of hole objects, each hole is array of player data (same shape)
  };

  // --- Elements ---
  const numPlayersInput = document.getElementById('numPlayers');
  const skinValueInput = document.getElementById('skinValue');
  const playersMinusBtn = document.getElementById('players-minus');
  const playersPlusBtn = document.getElementById('players-plus');
  const skinMinusBtn = document.getElementById('skin-minus');
  const skinPlusBtn = document.getElementById('skin-plus');
  const startGameBtn = document.getElementById('startGameBtn');
  const setupDiv = document.getElementById('setup');
  const gameDiv = document.getElementById('game');
  const currentHoleSpan = document.getElementById('currentHole');
  const playersTableBody = document.getElementById('playersTableBody');
  const prevHoleBtn = document.getElementById('prevHoleBtn');
  const nextHoleBtn = document.getElementById('nextHoleBtn');
  const totalMoneyList = document.getElementById('totalMoneyList');

  // --- Load/save state from localStorage ---
  function saveState() {
    localStorage.setItem('golfBetState', JSON.stringify(state));
  }
  function loadState() {
    const saved = localStorage.getItem('golfBetState');
    if(saved){
      state = JSON.parse(saved);
      // Ensure holeData length and players length matches numPlayers
      while(state.players.length < state.numPlayers){
        state.players.push({name:`Player ${state.players.length+1}`, handicap:0, strokes:0, bonus:0, penalty:0});
      }
      while(state.players.length > state.numPlayers){
        state.players.pop();
      }
      if(state.holeData.length < 18) {
        while(state.holeData.length < 18){
          const hole = [];
          for(let i=0;i<state.numPlayers;i++){
            hole.push({strokes:0, bonus:0, penalty:0});
          }
          state.holeData.push(hole);
        }
      }
    }
  }

  // --- Init players on start ---
  function initPlayers(){
    state.players = [];
    for(let i=0; i<state.numPlayers; i++){
      state.players.push({
        name: `Player ${i+1}`,
        handicap: 0,
        strokes: 0,
        bonus: 0,
        penalty: 0
      });
    }
    state.holeData = [];
    for(let h=0; h<18; h++){
      const hole = [];
      for(let i=0; i<state.numPlayers; i++){
        hole.push({strokes:0, bonus:0, penalty:0});
      }
      state.holeData.push(hole);
    }
    state.currentHole = 1;
  }

  // --- Event handlers for + / - buttons ---
  playersMinusBtn.onclick = () => {
    if(state.numPlayers > 2){
      state.numPlayers--;
      numPlayersInput.value = state.numPlayers;
      saveState();
    }
  };
  playersPlusBtn.onclick = () => {
    if(state.numPlayers < 8){
      state.numPlayers++;
      numPlayersInput.value = state.numPlayers;
      saveState();
    }
  };
  skinMinusBtn.onclick = () => {
    if(state.skin > 1){
      state.skin--;
      skinValueInput.value = state.skin;
      saveState();
    }
  };
  skinPlusBtn.onclick = () => {
    if(state.skin < 100){
      state.skin++;
      skinValueInput.value = state.skin;
      saveState();
    }
  };

  // --- Render the players input table ---
  function renderPlayersTable() {
    playersTableBody.innerHTML = '';
    const holeIndex = state.currentHole - 1;
    for(let i=0; i<state.numPlayers; i++){
      const player = state.players[i];
      // Get hole data
      const hole = state.holeData[holeIndex] || [];
      const hd = hole[i] || {strokes:0, bonus:0, penalty:0};

      const tr = document.createElement('tr');
      // Player label
      const playerLabelTd = document.createElement('td');
      playerLabelTd.textContent = `Player ${i+1}`;
      tr.appendChild(playerLabelTd);

      // Name input
      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = player.name;
      nameInput.onchange = e => {
        state.players[i].name = e.target.value.trim() || `Player ${i+1}`;
        saveState();
      };
      nameTd.appendChild(nameInput);
      tr.appendChild(nameTd);

      // Handicap input
      const handicapTd = document.createElement('td');
      const handicapInput = document.createElement('input');
      handicapInput.type = 'number';
      handicapInput.min = 0;
      handicapInput.max = 54;
      handicapInput.value = player.handicap;
      handicapInput.onchange = e => {
        let val = parseInt(e.target.value);
        if (isNaN(val) || val < 0) val = 0;
        if (val > 54) val = 54;
        state.players[i].handicap = val;
        saveState();
        renderPlayersTable();
        calculateAndRenderMoney();
      };
      handicapTd.appendChild(handicapInput);
      tr.appendChild(handicapTd);

      // Strokes input with +/- buttons
      tr.appendChild(createCounterCell(i, 'strokes', hd.strokes));
      tr.appendChild(createCounterCell(i, 'bonus', hd.bonus));
      tr.appendChild(createCounterCell(i, 'penalty', hd.penalty));

      // Money cell
      const moneyTd = document.createElement('td');
      moneyTd.id = `money-player-${i}`;
      moneyTd.textContent = '$0';
      tr.appendChild(moneyTd);

      playersTableBody.appendChild(tr);
    }
  }

  function createCounterCell(playerIndex, field, value) {
    const td = document.createElement('td');
    td.style.whiteSpace = 'nowrap';
    const minusBtn = document.createElement('button');
    minusBtn.textContent = '-';
    minusBtn.onclick = () => {
      let holeIndex = state.currentHole - 1;
      let val = state.holeData[holeIndex][playerIndex][field];
      val = Math.max(0, val - 1);
      state.holeData[holeIndex][playerIndex][field] = val;
      saveState();
      renderPlayersTable();
      calculateAndRenderMoney();
    };
    const plusBtn = document.createElement('button');
    plusBtn.textContent = '+';
    plusBtn.onclick = () => {
      let holeIndex = state.currentHole - 1;
      let val = state.holeData[holeIndex][playerIndex][field];
      val = val + 1;
      state.holeData[holeIndex][playerIndex][field] = val;
      saveState();
      renderPlayersTable();
      calculateAndRenderMoney();
    };
    const numSpan = document.createElement('input');
    numSpan.type = 'number';
    numSpan.min = 0;
    numSpan.value = value;
    numSpan.style.width = '40px';
    numSpan.onchange = e => {
      let val = parseInt(e.target.value);
      if (isNaN(val) || val < 0) val = 0;
      let holeIndex = state.currentHole - 1;
      state.holeData[holeIndex][playerIndex][field] = val;
      saveState();
      renderPlayersTable();
      calculateAndRenderMoney();
    };

    td.appendChild(minusBtn);
    td.appendChild(numSpan);
    td.appendChild(plusBtn);

    return td;
  }

  // --- Handicap compensation formula ---
  // compensation = (player2.handicap - player1.handicap) * 0.7
  // player1 pays player2 if player2 handicap is higher
  function calcHandicapCompensation(p1Index, p2Index) {
    const h1 = state.players[p1Index].handicap;
    const h2 = state.players[p2Index].handicap;
    return (h2 - h1) * 0.7;
  }

  // --- Calculate money for current hole ---
  function calculateAndRenderMoney() {
    const holeIndex = state.currentHole - 1;
    const hole = state.holeData[holeIndex];
    const numPlayers = state.numPlayers;
    const skin = state.skin;

    // Initialize money array for this hole
    let money = Array(numPlayers).fill(0);

    // Get strokes for each player in this hole
    const strokesArr = hole.map(h => h.strokes);

    // Determine who won the hole: player with minimum strokes
    const minStroke = Math.min(...strokesArr);

    // For each pair of players, calculate handicap compensation and strokes difference
    // Then calculate money won/lost based on skin value and hole win
    for (let i = 0; i < numPlayers; i++) {
      for (let j = 0; j < numPlayers; j++) {
        if (i === j) continue;
        const comp = calcHandicapCompensation(i, j);

        // Adjust strokes by handicap compensation
        const adjStrokeI = strokesArr[i] + comp;
        const adjStrokeJ = strokesArr[j] + calcHandicapCompensation(j, i);

        // Determine hole win/loss/tie between i and j
        let holeResult = 0; // 1 if i wins, -1 if i loses, 0 tie

        if (adjStrokeI < adjStrokeJ) holeResult = 1;
        else if (adjStrokeI > adjStrokeJ) holeResult = -1;

        // Skin money from hole result:
        // Win hole = + skin
        // Lose hole = - skin
        // Tie = 0
        money[i] += holeResult * skin;

        // Additional money for strokes difference:
        // (stroke difference) * skin, positive if i better than j, negative if worse
        // Only count difference if player i actually won the hole vs j
        if (holeResult === 1) {
          const strokeDiff = Math.floor(adjStrokeJ - adjStrokeI);
          if (strokeDiff > 0) {
            money[i] += strokeDiff * skin;
            money[j] -= strokeDiff * skin;
          }
        }
      }
    }

    // Now apply Bonus and Penalty with zero sum logic:
    // Player with n bonus gains n * skin * (numPlayers-1)
    // Each other player loses n * skin
    // Player with n penalty loses n * skin * (numPlayers-1)
    // Each other player gains n * skin
    for (let i = 0; i < numPlayers; i++) {
      const b = hole[i].bonus || 0;
      const p = hole[i].penalty || 0;
      const opponentCount = numPlayers - 1;

      const totalBonusMoney = b * skin * opponentCount;
      const totalPenaltyMoney = p * skin * opponentCount;

      money[i] += totalBonusMoney;
      money[i] -= totalPenaltyMoney;

      for (let j = 0; j < numPlayers; j++) {
        if (j === i) continue;
        money[j] -= b * skin;  // others lose bonus amount
        money[j] += p * skin;  // others gain penalty amount
      }
    }

    // Update money display & color
    for(let i=0; i<numPlayers; i++){
      const td = document.getElementById(`money-player-${i}`);
      const val = money[i];
      td.textContent = (val >= 0 ? '+' : '') + val.toFixed(0);
      td.className = val > 0 ? 'money-positive' : val < 0 ? 'money-negative' : '';
    }

    // Save hole money to state for total calculation
    state.holeData[holeIndex].money = money;

    saveState();
    renderTotalMoney();
  }

  // --- Render total money over all holes ---
  function renderTotalMoney(){
    const totals = Array(state.numPlayers).fill(0);
    for(let h=0; h<state.holeData.length; h++){
      const holeMoney = state.holeData[h].money || Array(state.numPlayers).fill(0);
      for(let i=0; i<state.numPlayers; i++){
        totals[i] += holeMoney[i];
      }
    }
    totalMoneyList.innerHTML = '';
    for(let i=0; i<state.numPlayers; i++){
      const li = document.createElement('li');
      const name = state.players[i].name;
      const val = totals[i];
      li.textContent = `${name}: ${val >= 0 ? '+' : ''}${val.toFixed(0)} $`;
      li.style.color = val > 0 ? 'green' : val < 0 ? 'red' : 'black';
      totalMoneyList.appendChild(li);
    }
  }

  // --- Render current hole ---
  function renderHole() {
    currentHoleSpan.textContent = state.currentHole;
    renderPlayersTable();
    calculateAndRenderMoney();
  }

  // --- Handlers for hole navigation ---
  prevHoleBtn.onclick = () => {
    if(state.currentHole > 1){
      state.currentHole--;
      saveState();
      renderHole();
    }
  };
  nextHoleBtn.onclick = () => {
    if(state.currentHole < 18){
      state.currentHole++;
      saveState();
      renderHole();
    }
  };

  // --- Start game button ---
  startGameBtn.onclick = () => {
    // Update state from inputs
    state.numPlayers = parseInt(numPlayersInput.value) || 4;
    state.skin = parseInt(skinValueInput.value) || 5;

    initPlayers();
    saveState();

    setupDiv.style.display = 'none';
    gameDiv.style.display = 'block';
    renderHole();
  };

  // --- Init ---
  loadState();

  if(state.holeData.length > 0){
    setupDiv.style.display = 'none';
    gameDiv.style.display = 'block';
    numPlayersInput.value = state.numPlayers;
    skinValueInput.value = state.skin;
    renderHole();
  } else {
    numPlayersInput.value = state.numPlayers;
    skinValueInput.value = state.skin;
  }
})();
</script>

</body>
</html>
